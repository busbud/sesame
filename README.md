# Sesame

Sensitive data storage service.

## Overview

Sesame provides a simple authenticated REST API for storing and
retrieving encrypted sensitive information. Data is salted, encrypted
with AES-256 and stored in PostgreSQL. Resources are identified by URIs
containing UUIDs.

## API

### Authentication

Clients authenticate via HTTP basic authentication, using their
lower-case client name as a username and their API key as a password.

### Create

```
POST /vault
```

Data to encrypt and store must be sent as a string in the `data` key,
either in `application/x-www-form-urlencoded` or `application/json`.

On success, responds with `201 Created` and sets the `Location` header
to the URI of the resource for use with `GET`, `PUT` or `DELETE`. The
URI is also sent in the response body.

### Read

```
GET /vault/:id
```

Must be requested with a URI returned from `POST /vault`.

On success, responds with `200 OK` and sends the decrypted data in the
response body.

Sets `Last-Modified` on responses, allowing use of `If-Modified-Since`.

### Update

```
PUT /vault/:id
```

Must be requested with a URI returned from `POST /vault`. Data to
encrypt and store must be sent as a string in the `data` key, same as
for `POST /vault`.

On success, responds with `204 No Content`.

### Delete

```
DELETE /vault/:id
```

Must be requested with a URI returned from `POST /vault`.

On success, responds with `204 No Content`.

## Configuration

In production, configuration is loaded from environment variables. In
development, configuration will also be loaded from `config.json` if it
exists.

```sh
# HTTP port.
PORT=6666

# PostgreSQL connection string.
DATABASE_URL=postgres://localhost/sesame

# Base resource URI.
BASE_URI=http://localhost:6666

# Comma-separated list of colon-separated ID/key pairs.
ENCRYPTION_KEYS=ex2:verysecure,ex1:keyboardcat

# API_KEY_ wildcard variables for client API keys.
API_KEY_MYCLIENT=anothercat
```

Or, as a `config.json`:

```json
{
  "port": 6666,
  "databaseURL": "postgres://localhost/sesame",
  "baseURI": "http://localhost:6666",
  "encryptionKeys": [
    { "id": "ex2", "key": "verysecure" },
    { "id": "ex1", "key": "keyboardcat" }
  ],
  "apiKeys": {
    "myclient": "anothercat"
  }
}
```

## Setup

Sesame requires a PostgreSQL database and at least one encryption key to
run.

### Database

There is currently no migration tool, but a fresh database can be set up
by running `migrations/i7yxy7p6.create-vault.up.sql`. Note that
superuser privileges may be required for `CREATE EXTENSION`.

### Encryption keys

Encryption keys can be generated by
`scripts/generate-encryption-key.js`.

### API keys

API keys can be generated by `scripts/generate-api-key.js`.

### HTTP server

The Node.js HTTP server can be started with `npm start`.

## Encryption key rotation

1. Generate a new encryption key and prepend it to the list. All new
   encryption from creates or updates will use the new key.
2. Run `npm run rotate` to re-encrypt existing data with the new key.
3. Remove the old key from the encryption key list.
